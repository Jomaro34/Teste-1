<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Assistente Local â€” CorreÃ§Ãµes + MemÃ³ria + DicionÃ¡rio</title>
<style>
  :root{--bg:#f3f6f9;--card:#fff;--accent:#0b63a7;--muted:#6b7280;--success:#059669;--danger:#dc2626}
  *{box-sizing:border-box}
  body{font-family:Inter,Segoe UI,Arial,sans-serif;background:var(--bg);margin:0;padding:24px}
  .wrap{max-width:1200px;margin:0 auto}
  header{display:flex;align-items:center;gap:16px;margin-bottom:18px;flex-wrap:wrap}
  h1{margin:0;font-size:20px}
  .grid{display:grid;grid-template-columns:1fr 420px;gap:18px}
  @media(max-width:900px){.grid{grid-template-columns:1fr}}
  .card{background:var(--card);padding:16px;border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,0.06)}
  textarea{width:100%;min-height:140px;border:1px solid #e6eef6;border-radius:8px;padding:12px;font-size:15px;font-family:inherit;resize:vertical}
  button{background:var(--accent);color:#fff;border:none;padding:8px 14px;border-radius:8px;cursor:pointer;font-size:14px;transition:opacity 0.2s}
  button:hover{opacity:0.9}
  button:disabled{opacity:0.5;cursor:not-allowed}
  .secondary{background:#475569}
  .success{background:var(--success)}
  .danger{background:var(--danger)}
  .muted{color:var(--muted);font-size:13px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .mem-list{max-height:300px;overflow:auto;border:1px solid #eef3f8;padding:8px;border-radius:8px;background:#fafbfc}
  .mem-item{padding:10px;border-bottom:1px solid #f1f5f9;background:#fff;margin-bottom:6px;border-radius:6px;cursor:pointer;transition:background 0.2s}
  .mem-item:hover{background:#f8fafc}
  .small{font-size:13px}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
  .pill{background:#eef6fb;padding:6px 10px;border-radius:999px;font-size:13px;color:var(--accent);font-weight:500}
  input[type="file"]{display:none}
  .rule-count{font-weight:600;color:var(--accent)}
  .search-result{padding:10px;border-radius:6px;margin-bottom:6px;background:#fff;border:1px solid #e0f2fe}
  mark{background:#fef08a;padding:2px 4px;border-radius:3px}
  .meta{font-size:12px;color:var(--muted);margin-top:4px}
  .footer{margin-top:12px;font-size:13px;color:var(--muted);padding:10px;background:#f8fafc;border-radius:8px}
  .alert{padding:10px;border-radius:8px;margin:10px 0;font-size:14px}
  .alert-success{background:#d1fae5;color:#065f46;border:1px solid #6ee7b7}
  .alert-info{background:#dbeafe;color:#1e40af;border:1px solid #93c5fd}
  .alert-warning{background:#fef3c7;color:#92400e;border:1px solid #fcd34d}
  h3,h4{margin-top:0}
  label.file-label{background:#475569;color:#fff;padding:8px 14px;border-radius:8px;cursor:pointer;font-size:14px;display:inline-block}
  label.file-label:hover{opacity:0.9}
  code{background:#f1f5f9;padding:2px 6px;border-radius:4px;font-size:13px;color:#334155}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>ğŸ› ï¸ Assistente Local â€” CorreÃ§Ãµes + MemÃ³ria + DicionÃ¡rio</h1>
    <div class="muted">Carrega automaticamente <code>rules.json</code>, <code>memoria.json</code> e <code>dicionario_raw.json</code></div>
  </header>

  <div id="alerts"></div>

  <div class="grid">
    <div class="card">
      <h3>âœï¸ Editor de Texto</h3>
      <textarea id="inputText" placeholder="Escreve ou cola o teu texto aqui..." spellcheck="true"></textarea>
      
      <div class="controls">
        <button id="btnCorrigir">ğŸ”§ Corrigir Texto</button>
        <button id="btnExplicar" class="secondary">ğŸ“ Explicar CorreÃ§Ãµes</button>
        <button id="btnAdicionar" class="success">ğŸ’¾ Guardar na MemÃ³ria</button>
        <button id="btnLimpar" class="secondary">ğŸ—‘ï¸ Limpar</button>
        <div class="pill">Regras ativas: <span id="ruleCount" class="rule-count">0</span></div>
      </div>

      <div style="height:16px"></div>
      <h4>ğŸ” Consulta de DicionÃ¡rio</h4>
      <div class="row">
        <input id="searchDic" placeholder="Palavra a procurar..." style="flex:1;padding:10px;border-radius:8px;border:1px solid #e6eef6;font-size:14px">
        <button id="btnConsultarDic" class="secondary">Consultar</button>
      </div>
      <div id="dicResults" style="margin-top:10px"></div>

      <div style="height:16px"></div>
      <h4>ğŸ“¥ Importar / Exportar</h4>
      <div class="row" style="gap:8px;margin-bottom:8px">
        <label class="file-label" for="fileRules">ğŸ“„ Importar Regras</label>
        <input id="fileRules" type="file" accept="application/json">
        
        <label class="file-label" for="fileMem">ğŸ“„ Importar MemÃ³ria</label>
        <input id="fileMem" type="file" accept="application/json">
        
        <button id="exportMem" class="success">ğŸ’¾ Exportar MemÃ³ria</button>
      </div>

      <div style="height:16px"></div>
      <h4>ğŸ“¤ Resultado / Output</h4>
      <textarea id="outputText" readonly style="background:#fafbfc"></textarea>

      <div class="footer">
        <strong>ğŸ’¡ Dica:</strong> Inicia um servidor HTTP local (<code>python -m http.server 8000</code>) e coloca os arquivos JSON na mesma pasta.
      </div>
    </div>

    <div class="card">
      <h3>ğŸ’¾ MemÃ³ria Inteligente</h3>

      <div style="display:flex;gap:8px;margin-bottom:12px;align-items:center">
        <input id="searchQ" placeholder="Pesquisar na memÃ³ria (fuzzy search)..." style="flex:1;padding:10px;border-radius:8px;border:1px solid #e6eef6;font-size:14px">
        <button id="btnSearch" class="secondary">ğŸ”</button>
      </div>

      <div class="row" style="margin-bottom:12px">
        <button id="btnAutoLoad">ğŸ“‚ Carregar memoria.json</button>
        <button id="btnClearMem" class="danger">ğŸ—‘ï¸ Limpar Tudo</button>
        <div class="pill">Itens: <span id="memCount" class="rule-count">0</span></div>
      </div>

      <div class="muted small" style="margin-bottom:6px">Clica num item para carregÃ¡-lo no editor:</div>
      <div class="mem-list" id="memoriaLista">
        <div class="muted" style="text-align:center;padding:20px">Nenhum item guardado ainda</div>
      </div>

      <div style="height:16px"></div>
      <h4>ğŸ”§ GestÃ£o de Regras</h4>
      <div class="muted small" style="margin-bottom:8px">
        As regras sÃ£o aplicadas sequencialmente. Suporta regex e funÃ§Ãµes de substituiÃ§Ã£o.
      </div>
      <button id="btnShowRules" class="secondary">ğŸ“‹ Ver / Editar Regras (JSON)</button>
    </div>
  </div>
</div>

<!-- Modal de regras -->
<div id="rulesModal" style="display:none;position:fixed;inset:0;background:rgba(2,6,23,0.6);align-items:center;justify-content:center;z-index:1000">
  <div style="width:90%;max-width:900px;background:#fff;border-radius:12px;padding:20px;max-height:90vh;overflow:auto">
    <h3>ğŸ“‹ Editor de Regras (JSON)</h3>
    <div class="muted small" style="margin-bottom:10px">
      Formato: <code>[{id, pattern, flags, replacement, description}, ...]</code>
    </div>
    <textarea id="rulesEditor" style="min-height:350px;width:100%;border:1px solid #e6eef6;border-radius:8px;padding:12px;font-family:monospace;font-size:13px"></textarea>
    <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
      <button id="saveRules" class="success">ğŸ’¾ Salvar AlteraÃ§Ãµes</button>
      <button id="closeRules" class="secondary">âœ–ï¸ Fechar</button>
    </div>
  </div>
</div>

<script>
// ================= UTILITÃRIOS =================
function showAlert(msg, type='info') {
  const alertBox = document.getElementById('alerts');
  const div = document.createElement('div');
  div.className = `alert alert-${type}`;
  div.textContent = msg;
  alertBox.appendChild(div);
  setTimeout(() => div.remove(), 4000);
}

function fuzzySearch(query, text) {
  query = query.toLowerCase();
  text = text.toLowerCase();
  let qi = 0;
  for(let i = 0; i < text.length && qi < query.length; i++) {
    if(text[i] === query[qi]) qi++;
  }
  return qi === query.length;
}

function highlightMatch(text, query) {
  if(!query) return text;
  const regex = new RegExp(`(${query})`, 'gi');
  return text.replace(regex, '<mark>$1</mark>');
}

// ================= DICIONÃRIO =================
let dicionario = {};

fetch('./dicionario_raw.json')
  .then(r => r.json())
  .then(json => {
    dicionario = json;
    showAlert(`âœ… DicionÃ¡rio carregado: ${Object.keys(dicionario).length} palavras`, 'success');
  })
  .catch(err => {
    console.warn('DicionÃ¡rio nÃ£o encontrado:', err);
    showAlert('âš ï¸ dicionario_raw.json nÃ£o encontrado. Coloca o ficheiro na mesma pasta.', 'warning');
  });

function consultarPalavra(palavra) {
  palavra = palavra.trim();
  
  // Busca exacta
  if(dicionario[palavra]) {
    return formatarDefinicoes(palavra, dicionario[palavra]);
  }
  
  // Busca parcial (case-insensitive)
  const matches = Object.keys(dicionario).filter(k => 
    k.toLowerCase().includes(palavra.toLowerCase())
  );
  
  if(matches.length === 0) {
    return `<div class="muted">âŒ Palavra "<strong>${palavra}</strong>" nÃ£o encontrada no dicionÃ¡rio.</div>`;
  }
  
  if(matches.length === 1) {
    return formatarDefinicoes(matches[0], dicionario[matches[0]]);
  }
  
  // MÃºltiplas correspondÃªncias
  let html = `<div class="alert alert-info">Encontradas ${matches.length} correspondÃªncias para "<strong>${palavra}</strong>":</div>`;
  matches.slice(0, 5).forEach(match => {
    html += formatarDefinicoes(match, dicionario[match]);
  });
  if(matches.length > 5) {
    html += `<div class="muted" style="margin-top:8px">... e mais ${matches.length - 5} resultados</div>`;
  }
  return html;
}

function formatarDefinicoes(palavra, definicoes) {
  let html = `<div class="search-result"><h4 style="margin:0 0 8px 0;color:var(--accent)">${palavra}</h4>`;
  definicoes.forEach((def, idx) => {
    html += `<div style="margin-bottom:8px">`;
    if(def.categoria) html += `<span style="background:#e0f2fe;padding:2px 6px;border-radius:4px;font-size:12px;margin-right:6px">${def.categoria}</span>`;
    html += `<strong>DefiniÃ§Ã£o:</strong> ${def.definicao}`;
    if(def.contexto) html += `<br><em style="color:var(--muted);font-size:13px">Contexto: ${def.contexto}</em>`;
    html += `</div>`;
  });
  html += `</div>`;
  return html;
}

document.getElementById('btnConsultarDic').addEventListener('click', () => {
  const palavra = document.getElementById('searchDic').value.trim();
  if(!palavra) {
    showAlert('âš ï¸ Escreve uma palavra para consultar', 'warning');
    return;
  }
  document.getElementById('dicResults').innerHTML = consultarPalavra(palavra);
});

document.getElementById('searchDic').addEventListener('keypress', (e) => {
  if(e.key === 'Enter') document.getElementById('btnConsultarDic').click();
});

// ================= REGRAS =================
let regras = [];

function carregarRegrasPadrao() {
  regras = [
    {id:'r_espacos', pattern:'\\s{2,}', flags:'g', replacement:' ', description:'Remove espaÃ§os duplicados'},
    {id:'r_virgula', pattern:'\\s+,', flags:'g', replacement:',', description:'Remove espaÃ§o antes de vÃ­rgula'},
    {id:'r_ponto', pattern:'\\s+\\.', flags:'g', replacement:'.', description:'Remove espaÃ§o antes de ponto'},
    {id:'r_exclamacao', pattern:'\\s+!', flags:'g', replacement:'!', description:'Remove espaÃ§o antes de !'},
    {id:'r_interrogacao', pattern:'\\s+\\?', flags:'g', replacement:'?', description:'Remove espaÃ§o antes de ?'},
    {id:'r_espaco_apos', pattern:'([,\\.!?:;])([A-Za-zÃ€-Ã¿])', flags:'g', replacement:'$1 $2', description:'Adiciona espaÃ§o apÃ³s pontuaÃ§Ã£o'},
  ];
  atualizarContagemRegras();
}

function atualizarContagemRegras() {
  document.getElementById('ruleCount').textContent = regras.length;
}

// Carregar rules.json automaticamente
fetch('./rules.json')
  .then(r => r.json())
  .then(json => {
    if(Array.isArray(json)) {
      regras = json;
      atualizarContagemRegras();
      showAlert(`âœ… Regras carregadas: ${regras.length} regras`, 'success');
    }
  })
  .catch(err => {
    console.warn('rules.json nÃ£o encontrado, usando regras padrÃ£o');
    carregarRegrasPadrao();
    showAlert('âš ï¸ rules.json nÃ£o encontrado. A usar regras padrÃ£o.', 'warning');
  });

let correcoes = [];

function corrigirTexto() {
  let texto = document.getElementById('inputText').value;
  if(!texto.trim()) {
    showAlert('âš ï¸ Escreve algo para corrigir!', 'warning');
    return;
  }
  
  correcoes = [];
  const textoOriginal = texto;
  
  for(const r of regras) {
    try {
      const re = new RegExp(r.pattern, r.flags || 'g');
      const antes = texto;
      texto = texto.replace(re, r.replacement);
      
      if(antes !== texto) {
        correcoes.push({
          regra: r.id,
          descricao: r.description,
          antes: antes.substring(0, 100),
          depois: texto.substring(0, 100)
        });
      }
    } catch(err) {
      console.error('Erro na regra', r.id, err);
    }
  }
  
  document.getElementById('outputText').value = texto;
  
  if(correcoes.length > 0) {
    showAlert(`âœ… ${correcoes.length} correÃ§Ã£o(Ãµes) aplicada(s)`, 'success');
  } else {
    showAlert('â„¹ï¸ Nenhuma correÃ§Ã£o necessÃ¡ria', 'info');
  }
}

function explicarCorrecoes() {
  if(correcoes.length === 0) {
    showAlert('â„¹ï¸ Executa "Corrigir Texto" primeiro', 'info');
    return;
  }
  
  let explicacao = 'ğŸ“ RELATÃ“RIO DE CORREÃ‡Ã•ES\n\n';
  correcoes.forEach((c, idx) => {
    explicacao += `${idx+1}. ${c.descricao}\n`;
    explicacao += `   Regra: ${c.regra}\n\n`;
  });
  
  document.getElementById('outputText').value = explicacao;
}

document.getElementById('btnCorrigir').addEventListener('click', corrigirTexto);
document.getElementById('btnExplicar').addEventListener('click', explicarCorrecoes);

// ================= MEMÃ“RIA =================
let memoria = [];

function adicionarMemoria() {
  const text = document.getElementById('inputText').value.trim();
  if(!text) {
    showAlert('âš ï¸ Escreve algo para guardar na memÃ³ria', 'warning');
    return;
  }
  
  const item = {
    id: Date.now().toString(),
    text: text,
    addedAt: new Date().toISOString()
  };
  
  memoria.unshift(item);
  atualizarListaMemoria();
  showAlert('âœ… Item adicionado Ã  memÃ³ria', 'success');
}

function atualizarListaMemoria(filtro = null) {
  const box = document.getElementById('memoriaLista');
  box.innerHTML = '';
  
  const items = filtro ? memoria.filter(m => fuzzySearch(filtro, m.text)) : memoria;
  
  if(items.length === 0) {
    box.innerHTML = '<div class="muted" style="text-align:center;padding:20px">Nenhum item encontrado</div>';
    document.getElementById('memCount').textContent = '0';
    return;
  }
  
  items.forEach(m => {
    const div = document.createElement('div');
    div.className = 'mem-item';
    
    const preview = m.text.length > 150 ? m.text.slice(0, 150) + '...' : m.text;
    const highlighted = filtro ? highlightMatch(preview, filtro) : preview;
    
    div.innerHTML = `
      <div style="font-weight:500;margin-bottom:4px">${highlighted}</div>
      <div class="meta">
        ğŸ†” ${m.id} â€¢ ğŸ“… ${new Date(m.addedAt).toLocaleString('pt-PT')}
      </div>
    `;
    
    div.addEventListener('click', () => {
      document.getElementById('inputText').value = m.text;
      showAlert('âœ… Item carregado no editor', 'success');
    });
    
    box.appendChild(div);
  });
  
  document.getElementById('memCount').textContent = memoria.length;
}

function pesquisarMemoria() {
  const query = document.getElementById('searchQ').value.trim();
  if(!query) {
    atualizarListaMemoria();
    return;
  }
  atualizarListaMemoria(query);
}

function carregarMemoriaJSON() {
  fetch('./memoria.json')
    .then(r => r.json())
    .then(json => {
      if(Array.isArray(json)) {
        memoria = json;
        atualizarListaMemoria();
        showAlert(`âœ… MemÃ³ria carregada: ${memoria.length} itens`, 'success');
      }
    })
    .catch(err => {
      showAlert('âš ï¸ memoria.json nÃ£o encontrado ou invÃ¡lido', 'warning');
    });
}

function limparMemoria() {
  if(!confirm('âš ï¸ Tens a certeza que queres limpar toda a memÃ³ria?')) return;
  memoria = [];
  atualizarListaMemoria();
  showAlert('ğŸ—‘ï¸ MemÃ³ria limpa', 'info');
}

function exportarMemoria() {
  if(memoria.length === 0) {
    showAlert('âš ï¸ MemÃ³ria vazia. Nada para exportar.', 'warning');
    return;
  }
  
  const blob = new Blob([JSON.stringify(memoria, null, 2)], {type: 'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `memoria_${Date.now()}.json`;
  a.click();
  URL.revokeObjectURL(url);
  showAlert('âœ… MemÃ³ria exportada com sucesso', 'success');
}

document.getElementById('btnAdicionar').addEventListener('click', adicionarMemoria);
document.getElementById('btnSearch').addEventListener('click', pesquisarMemoria);
document.getElementById('searchQ').addEventListener('input', (e) => {
  if(e.target.value === '') atualizarListaMemoria();
});
document.getElementById('btnAutoLoad').addEventListener('click', carregarMemoriaJSON);
document.getElementById('btnClearMem').addEventListener('click', limparMemoria);
document.getElementById('exportMem').addEventListener('click', exportarMemoria);

// Carregar memoria.json automaticamente
fetch('./memoria.json')
  .then(r => r.json())
  .then(json => {
    if(Array.isArray(json)) {
      memoria = json;
      atualizarListaMemoria();
      showAlert(`âœ… MemÃ³ria carregada automaticamente: ${memoria.length} itens`, 'success');
    }
  })
  .catch(() => {
    console.log('memoria.json nÃ£o encontrado (normal na primeira execuÃ§Ã£o)');
  });

// ================= IMPORT/EXPORT =================
document.getElementById('fileRules').addEventListener('change', (e) => {
  const file = e.target.files[0];
  if(!file) return;
  
  const reader = new FileReader();
  reader.onload = (ev) => {
    try {
      const json = JSON.parse(ev.target.result);
      if(Array.isArray(json)) {
        regras = json;
        atualizarContagemRegras();
        showAlert(`âœ… ${regras.length} regras importadas`, 'success');
      }
    } catch(err) {
      showAlert('âŒ Erro ao importar regras: JSON invÃ¡lido', 'warning');
    }
  };
  reader.readAsText(file);
});

document.getElementById('fileMem').addEventListener('change', (e) => {
  const file = e.target.files[0];
  if(!file) return;
  
  const reader = new FileReader();
  reader.onload = (ev) => {
    try {
      const json = JSON.parse(ev.target.result);
      if(Array.isArray(json)) {
        memoria = json;
        atualizarListaMemoria();
        showAlert(`âœ… ${memoria.length} itens de memÃ³ria importados`, 'success');
      }
    } catch(err) {
      showAlert('âŒ Erro ao importar memÃ³ria: JSON invÃ¡lido', 'warning');
    }
  };
  reader.readAsText(file);
});

// ================= MODAL DE REGRAS =================
document.getElementById('btnShowRules').addEventListener('click', () => {
  document.getElementById('rulesEditor').value = JSON.stringify(regras, null, 2);
  document.getElementById('rulesModal').style.display = 'flex';
});

document.getElementById('closeRules').addEventListener('click', () => {
  document.getElementById('rulesModal').style.display = 'none';
});

document.getElementById('saveRules').addEventListener('click', () => {
  try {
    const json = JSON.parse(document.getElementById('rulesEditor').value);
    if(!Array.isArray(json)) throw new Error('Deve ser um array');
    regras = json;
    atualizarContagemRegras();
    showAlert('âœ… Regras atualizadas com sucesso', 'success');
    document.getElementById('rulesModal').style.display = 'none';
  } catch(err) {
    showAlert('âŒ JSON invÃ¡lido. Verifica a sintaxe.', 'warning');
  }
});

// ================= OUTROS =================
document.getElementById('btnLimpar').addEventListener('click', () => {
  document.getElementById('inputText').value = '';
  document.getElementById('outputText').value = '';
  correcoes = [];
});

// InicializaÃ§Ã£o
atualizarListaMemoria();
console.log('ğŸš€ Assistente Local inicializado');
</script>
</body>
</html>
