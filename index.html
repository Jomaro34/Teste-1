<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Livro de Seres Imagin√°rios / Book of Imaginary Beings</title>
<link rel="icon" href="favicon.png" type="image/png">
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<style>
  :root{
    --accent:#3498db;
    --bg-grad-start:#667eea;
    --bg-grad-end:#764ba2;
    --panel-bg:#ffffff;
    --text:#2c3e50;
    --highlight:rgba(255,235,59,0.6);
  }

  *{box-sizing:border-box;margin:0;padding:0;text-decoration:none}
  body{
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
    background: linear-gradient(135deg, var(--bg-grad-start) 0%, var(--bg-grad-end) 100%);
    color:var(--text);
    min-height:100vh;
    display:flex;
    flex-direction:column;
    align-items:stretch;
  }

  /* Header */
  .header{
    background: rgba(255,255,255,0.95);
    padding:24px 16px;
    text-align:center;
    box-shadow:0 4px 8px rgba(0,0,0,0.08);
  }
  .header h1{font-size:1.9rem;font-weight:700;margin-bottom:8px}
  .header p.subtitle{
    display:inline-block;
    background:rgba(255,255,255,0.9);
    padding:6px 10px;border-radius:6px;color:var(--text);
    font-size:1rem;margin-bottom:8px;
  }
  .header a.credit{
    display:block;margin-top:8px;color:#000;font-weight:700;
  }

  /* Toolbar */
  .toolbar{
    background: rgba(44,62,80,0.95);
    color:#fff;padding:12px 14px;
    display:flex;gap:12px;align-items:center;flex-wrap:wrap;
    position:sticky;top:0;z-index:40;
  }
  .search-box{
    display:flex;gap:8px;align-items:center;flex:1;min-width:220px;
  }
  .search-box input{
    flex:1;padding:10px 12px;border-radius:8px;border:none;font-size:14px;
  }
  .search-box button{
    background:var(--accent);border:none;padding:10px 12px;border-radius:8px;color:#fff;cursor:pointer;
  }
  .controls{display:flex;gap:8px;align-items:center}
  .controls button, .controls a{
    background:var(--accent);color:#fff;border:none;padding:8px 10px;border-radius:8px;cursor:pointer;
  }
  .page-info{color:#fff;background:rgba(255,255,255,0.08);padding:6px 10px;border-radius:8px;font-weight:600}

  /* Layout */
  .content{
    display:flex;gap:18px;max-width:1400px;margin:20px auto;padding:0 16px;width:100%;
    align-items:flex-start;
  }

  /* Sidebar results */
  .sidebar{
    width:340px;background:var(--panel-bg);border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,0.2);
    max-height:calc(100vh - 180px);overflow:auto;padding:12px;display:none;
  }
  .sidebar.active{display:block}
  .sidebar h4{margin-bottom:8px}
  .result-item{padding:12px;border-bottom:1px solid #f0f0f0;cursor:pointer}
  .result-item:hover{background:#fafafa}
  .result-page{font-size:12px;color:#7f8c8d;font-weight:700;margin-bottom:6px}
  .result-excerpt{font-size:14px;color:var(--text);line-height:1.4}
  .result-excerpt mark{background:var(--highlight);padding:2px 3px;border-radius:3px;font-weight:700}

  /* PDF panel */
  .pdf-panel{
    flex:1;background:var(--panel-bg);border-radius:12px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,0.2);
    position:relative;min-height:60vh;display:flex;justify-content:center;align-items:flex-start;
  }
  #pdf-canvas{max-width:100%;border-radius:6px;display:block}
  .loading{padding:40px;text-align:center;color:#7f8c8d}
  .spinner{border:4px solid #ecf0f1;border-top:4px solid var(--accent);border-radius:50%;width:48px;height:48px;animation:spin 1s linear infinite;margin:18px auto}
  @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}

  /* Highlight overlay container */
  .overlay-container{
    position:absolute;left:20px;right:20px;top:20px;bottom:20px;pointer-events:none;
  }
  .hl{
    position:absolute;background:var(--highlight);border-radius:3px;pointer-events:none;
    box-shadow:0 0 0 2px rgba(255,235,59,0.12) inset;
  }

  /* Responsive */
  @media (max-width:1000px){
    .sidebar{width:100%;max-height:260px}
    .content{flex-direction:column;gap:12px;padding-bottom:40px}
    .pdf-panel{min-height:50vh;padding:12px}
  }

</style>
</head>
<body>

  <header class="header">
    <h1>üìö Livro de Seres Imagin√°rios / Book of Imaginary Beings</h1>
    <p class="subtitle">Explore o mundo dos Seres Imagin√°rios / Explore the world of Imaginary Beings</p>
    <a class="credit" href="https://jomaro34.github.io/Jomaro-Cabrela/" target="_blank">@2025 Jomaro Cabrela</a>
  </header>

  <div class="toolbar" role="toolbar" aria-label="PDF controls">
    <div class="search-box">
      <input id="search-input" type="search" placeholder="üîç Pesquisar no documento (palavra ou frase)..." aria-label="Pesquisar no documento">
      <button id="search-btn" title="Procurar">Procurar</button>
      <button id="clear-btn" title="Limpar">Limpar</button>
    </div>

    <div class="controls" role="group" aria-label="Controles de visualiza√ß√£o">
      <button id="zoom-out" title="Diminuir zoom">‚àí</button>
      <button id="zoom-in" title="Aumentar zoom">+</button>
      <button id="prev-page" title="P√°gina anterior">‚Üê</button>
      <div class="page-info" id="page-info">P√°gina: -/-</div>
      <button id="next-page" title="Pr√≥xima p√°gina">‚Üí</button>
      <a id="download-link" href="Seres_Imaginarios.pdf" download="Seres_Imaginarios.pdf" title="Descarregar PDF">‚¨áÔ∏è Download PDF</a>
    </div>
  </div>

  <main class="content">
    <aside class="sidebar" id="sidebar" aria-live="polite">
      <h4>üìã Resultados da Pesquisa</h4>
      <div id="results"></div>
    </aside>

    <section class="pdf-panel" id="pdf-panel" aria-label="Visualizador do PDF">
      <div class="loading" id="loading">
        <h2>üìÑ A carregar PDF...</h2>
        <div class="spinner"></div>
        <p id="loading-name">Seres_Imaginarios.pdf</p>
      </div>

      <div class="overlay-container" id="overlay-container" aria-hidden="true"></div>
      <canvas id="pdf-canvas" style="display:none"></canvas>
    </section>
  </main>

<script>
/* --------------------------------------------------------------------------------
  Visualizador PDF + pesquisa com √≠ndice lateral e destaque no PDF (overlay divs)
  Usa PDF.js (v3.x). Copia este ficheiro para a mesma pasta do Seres_Imaginarios.pdf
  -------------------------------------------------------------------------------- */

pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

const URL_PDF = 'Seres_Imaginarios.pdf'; // nome do ficheiro
const canvas = document.getElementById('pdf-canvas');
const ctx = canvas.getContext('2d');
const loadingEl = document.getElementById('loading');
const overlayContainer = document.getElementById('overlay-container');
const resultsEl = document.getElementById('results');
const sidebar = document.getElementById('sidebar');
const pageInfo = document.getElementById('page-info');

let pdfDoc = null;
let pageNum = 1;
let scale = 1.5;
let pageRendering = false;
let pageNumPending = null;
let currentSearchTerm = '';
let matchesByPage = {}; // { pageNumber: [ {item, transform, rects, excerptIndex, excerptTextIndex } ] }
let pageTextStore = {}; // cache textContent per page

// stopwords para filtrar excertos curtos irrelevantes (apenas para melhorar result list)
const stopWords = new Set(["e","de","o","a","que","com","em","para","os","as","um","uma","no","na","dos","das","ao","√†","do","da","se","por","como","mais","ou","s√≥","mas","foi","ser","est√°","est√£o","nas","nos","s√£o","era","tem","h√°","bem","lhe","eles","elas","isso","isto"]);

/* ----- Carregar PDF ----- */
async function loadPDF(url){
  try{
    const loadingTask = pdfjsLib.getDocument(url);
    pdfDoc = await loadingTask.promise;
    pageInfo.textContent = `P√°gina: ${pageNum}/${pdfDoc.numPages}`;
    loadingEl.style.display = 'none';
    canvas.style.display = 'block';
    renderPage(pageNum);
  }catch(err){
    loadingEl.innerHTML = '<h2>‚ùå Erro ao carregar PDF</h2><p>Verifique se o ficheiro existe e que est√°s a servir via HTTP (ex.: python -m http.server).</p>';
    console.error(err);
  }
}

/* ----- Renderizar p√°gina ----- */
async function renderPage(num){
  pageRendering = true;
  // limpar overlays anteriores
  clearOverlays();

  const page = await pdfDoc.getPage(num);
  const viewport = page.getViewport({ scale: scale });
  canvas.height = viewport.height;
  canvas.width = viewport.width;

  // renderizar no canvas
  await page.render({ canvasContext: ctx, viewport: viewport }).promise;
  pageRendering = false;
  pageInfo.textContent = `P√°gina: ${num}/${pdfDoc.numPages}`;

  // armazenar texto da p√°gina (se ainda n√£o)
  if(!pageTextStore[num]){
    const textContent = await page.getTextContent();
    pageTextStore[num] = textContent;
  }

  // se h√° termo de pesquisa, desenhar overlays para a p√°gina atual
  if(currentSearchTerm){
    drawHighlightsForPage(num);
  }

  if(pageNumPending !== null){
    const next = pageNumPending; pageNumPending = null; renderPage(next);
  }
}

/* ----- Util: fila de render ----- */
function queueRenderPage(num){
  if(pageRendering){ pageNumPending = num; }
  else { renderPage(num); }
}

/* ----- Navega√ß√£o e zoom ----- */
document.getElementById('prev-page').addEventListener('click', ()=>{ if(pageNum<=1) return; pageNum--; queueRenderPage(pageNum); });
document.getElementById('next-page').addEventListener('click', ()=>{ if(pageNum>=pdfDoc.numPages) return; pageNum++; queueRenderPage(pageNum); });
document.getElementById('zoom-in').addEventListener('click', ()=>{ scale += 0.25; renderPage(pageNum); });
document.getElementById('zoom-out').addEventListener('click', ()=>{ if(scale>0.5){ scale -= 0.25; renderPage(pageNum); } });

/* ----- Pesquisa ----- */
document.getElementById('search-btn').addEventListener('click', searchPDF);
document.getElementById('clear-btn').addEventListener('click', clearSearch);
document.getElementById('search-input').addEventListener('keypress', (e)=>{ if(e.key==='Enter') searchPDF(); });

async function searchPDF(){
  const q = document.getElementById('search-input').value.trim();
  if(!q || !pdfDoc){ alert('Escreve uma palavra ou frase e tenta novamente.'); return; }

  currentSearchTerm = q.toLowerCase();
  matchesByPage = {};
  resultsEl.innerHTML = '';
  sidebar.classList.remove('active');

  // procurar p√°gina a p√°gina
  for(let p=1; p<=pdfDoc.numPages; p++){
    const page = await pdfDoc.getPage(p);
    const textContent = await page.getTextContent();
    const pageText = textContent.items.map(it=>it.str).join(' ');
    const pageTextLower = pageText.toLowerCase();

    let idx = pageTextLower.indexOf(currentSearchTerm);
    if(idx !== -1){
      // encontrar todas as ocorr√™ncias nesta p√°gina
      // para cada item do textContent, verificamos se cont√©m o termo e capturamos posi√ß√£o/transform
      const pageMatches = [];
      textContent.items.forEach((item, itemIndex)=>{
        const s = item.str || '';
        if(!s) return;
        const sLower = s.toLowerCase();
        if(sLower.includes(currentSearchTerm)){
          pageMatches.push({ item, itemIndex });
        }
      });

      if(pageMatches.length){
        // guardar textContent para uso posterior
        pageTextStore[p] = textContent;
        matchesByPage[p] = pageMatches;
      }
    }
  }

  // gerar lista de resultados com excertos (first occurrence per page)
  const pages = Object.keys(matchesByPage).map(n=>parseInt(n)).sort((a,b)=>a-b);
  if(pages.length===0){
    resultsEl.innerHTML = '<div style="padding:12px;color:#a00">‚úó Nenhum resultado encontrado</div>';
    sidebar.classList.remove('active');
    currentSearchTerm = '';
    clearOverlays();
    return;
  }

  sidebar.classList.add('active');

  pages.forEach(pageNumKey=>{
    // criar excerto: pega-se o texto da p√°gina e extrai em torno da primeira ocorr√™ncia
    const textContent = pageTextStore[pageNumKey];
    const pageText = textContent.items.map(it=>it.str).join(' ');
    const idx = pageText.toLowerCase().indexOf(currentSearchTerm);
    const start = Math.max(0, idx-80);
    const end = Math.min(pageText.length, idx + currentSearchTerm.length + 80);
    const excerpt = (start>0? '...':'') + pageText.substring(start,end) + (end<pageText.length? '...':'');

    // highlight palavra no excerpt (escapa HTML)
    const safeExcerpt = escapeHTML(excerpt);
    const highlightHTML = safeExcerpt.replace(new RegExp(escapeRegExp(currentSearchTerm),'gi'), match => `<mark>${match}</mark>`);

    // construir item
    const itemDiv = document.createElement('div');
    itemDiv.className = 'result-item';
    const pageDiv = document.createElement('div');
    pageDiv.className = 'result-page';
    pageDiv.textContent = `üìÑ P√°gina ${pageNumKey}`;
    const exDiv = document.createElement('div');
    exDiv.className = 'result-excerpt';
    exDiv.innerHTML = highlightHTML;

    itemDiv.appendChild(pageDiv);
    itemDiv.appendChild(exDiv);

    itemDiv.addEventListener('click', ()=>{
      // ao clicar: ir para a p√°gina e focalizar (criar overlays) ‚Äî escolher primeira ocorr√™ncia dessa p√°gina
      pageNum = pageNumKey;
      queueRenderPage(pageNum);
      setTimeout(()=>{ // espera renderiza√ß√£o
        drawHighlightsForPage(pageNumKey, true);
      }, 120); // timing razo√°vel
      // mobile: scroll para ver painel PDF
      if(window.innerWidth < 1000) window.scrollTo({top: document.querySelector('.pdf-panel').offsetTop - 10, behavior:'smooth'});
    });

    resultsEl.appendChild(itemDiv);
  });

  // desenhar overlays para p√°gina atual se incluir matches
  drawHighlightsForPage(pageNum);
}

/* ----- Desenhar highlights (overlays) para uma p√°gina ----- */
async function drawHighlightsForPage(pNum, focusFirst=false){
  // limpar overlays
  clearOverlays();

  if(!matchesByPage[pNum]) return;

  const page = await pdfDoc.getPage(pNum);
  const viewport = page.getViewport({ scale: scale });
  const textContent = pageTextStore[pNum] || await page.getTextContent();

  // Para cada item que cont√©m o termo, calculamos transform e coordenadas para overlay
  const pageMatches = matchesByPage[pNum];

  // Obter transform por item:
  pageMatches.forEach(matchObj=>{
    const item = matchObj.item;
    // transform item.transform -> posi√ß√£o em user space then map to viewport
    const transform = pdfjsLib.Util.transform(viewport.transform, item.transform);
    // x,y s√£o transform[4], transform[5] ; width ~ item.width * viewport.scale ; height ~ item.height * viewport.scale
    const x = transform[4];
    const y = transform[5];
    const width = (item.width || (item.str.length*6)) * viewport.scale; // fallback width estimate
    const height = (item.height || 10) * viewport.scale;

    // canvas Y origin is top, but pdf transform gives y distance from bottom ‚Äî we need to convert:
    const top = canvas.offsetTop + (canvas.height - y - height);
    const left = canvas.offsetLeft + x;

    // create overlay div positioned relative to overlayContainer coordinates
    // overlayContainer is absolutely placed over canvas area with same padding; compute offsets within it
    // get bounding rects to convert page coords -> overlay coords
    const canvasRect = canvas.getBoundingClientRect();
    const containerRect = overlayContainer.getBoundingClientRect();

    // position relative to overlayContainer:
    const relLeft = (canvasRect.left - containerRect.left) + x;
    const relTop = (canvasRect.top - containerRect.top) + (canvas.height - y - height);

    const hl = document.createElement('div');
    hl.className = 'hl';
    hl.style.left = Math.round(relLeft) + 'px';
    hl.style.top = Math.round(relTop) + 'px';
    hl.style.width = Math.round(width) + 'px';
    hl.style.height = Math.max( Math.round(height), 8 ) + 'px';
    overlayContainer.appendChild(hl);
  });

  // Se pediram foco no primeiro destaque, animar scroll ou efeito
  if(focusFirst){
    const first = overlayContainer.querySelector('.hl');
    if(first){
      first.style.boxShadow = '0 0 0 3px rgba(255,235,59,0.3)';
      setTimeout(()=>{ first.style.boxShadow = 'none'; }, 1200);
    }
  }
}

/* ----- Clear overlays ----- */
function clearOverlays(){
  overlayContainer.innerHTML = '';
}

/* ----- Clear search ----- */
function clearSearch(){
  document.getElementById('search-input').value = '';
  currentSearchTerm = '';
  matchesByPage = {};
  pageTextStore = {}; // optional: clear cache
  resultsEl.innerHTML = '';
  sidebar.classList.remove('active');
  clearOverlays();
  // re-render page (to remove overlays)
  renderPage(pageNum);
}

/* ----- Helpers ----- */
function escapeHTML(str){
  return str.replace(/[&<>"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]; });
}
function escapeRegExp(s){ return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }

/* ----- Inicializar ----- */
loadPDF(URL_PDF);

/* ----- Teclado: navegar p√°ginas com setas ------ */
document.addEventListener('keydown', (e)=>{
  if(e.key === 'ArrowLeft') document.getElementById('prev-page').click();
  else if(e.key === 'ArrowRight') document.getElementById('next-page').click();
});
</script>

</body>
</html>
